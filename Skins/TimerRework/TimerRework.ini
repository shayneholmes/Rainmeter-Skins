;---------------------------------------------------------------------
; MinimalTimer
; Based on ARCS

[Rainmeter]
Update=1000
DynamicWindowSize=0

;-----
; Skin-specific stuff

; Click to disable flashing
LeftMouseUpAction=[!DisableMeasure flashCounter][!Update]

; Show quick buttons on hover
MouseOverAction=[!SetVariable StateButtonsHidden 0][!UpdateMeterGroup ButtonGroup][!Redraw]
MouseLeaveAction=[!SetVariable StateButtonsHidden 1][!UpdateMeterGroup ButtonGroup][!Redraw]

[Variables]
@includeSettings=#SKINSPATH#Settings.inc
@includeState=#@#state.inc

; Presets
QuickTimer1PresetMinutes=15
QuickTimer1Color=255,0,0,255
QuickTimer2PresetMinutes=5
QuickTimer2Color=96,96,128,255
DefaultTimerLengthMinutes=15
DefaultTimerColor=168,168,168,255

; Stopwatch Text
; Adjust Alpha value to show or hide (0=hide, 255=show)
Font=Calibri
FontSize=16
FontColor=#ThemeColorFull#,255

; Visual theme values

WidgetSize=96
ArcBorderWidth=4
ArcBorderInnerRadiusRatio=(1-#ArcBorderWidth#/#WidgetSize#*2)
ArcBorderOuterRadiusRatio=1
ArcTrackInnerRadiusRatio=0
ArcTrackOuterRadiusRatio=#ArcBorderInnerRadiusRatio#
ArcTimerWidth=70
ArcTimerOuterRadiusRatio=(#ArcBorderInnerRadiusRatio#+0.01)
ArcButtonRadiusRatio=1

; Theme colors.
ColorBorder=#ThemeColorFull#,255
ColorBackground=0,0,0,255

; Timer config values
MaximumTimeDisplayed=1800
FlashTimeoutSeconds=300

;----------
; Internal state
StateButtonsHidden=1
; Timer variables
TimerDuration=0
EndOfTimerHash=0.41
; Misc
ArcRadius=(#WidgetSize#/2)
; Variables in external state file
; TimerEndOfTimer=0
; ColorTimerArc=#DefaultTimerColor#

;----------------------------------------------
; MEASURES

[MeasureInput]
Measure=Plugin
Plugin=InputText
SolidColor=0,0,0,255
FontColor=FFFFFF
FontFace=Segoe UI
FontSize=10
FocusDismiss=1
X=110
Y=110
H=25
W=40
DefaultValue=#DefaultTimerLengthMinutes#
Command1=!SetVariable ActiveTimerCount 0
Command2=!SetVariable TimerDuration ($UserInput$*60) #CURRENTCONFIG#
Command3=!SetVariable ColorTimerArc #DefaultTimerColor# #CURRENTCONFIG#
Command4=!EnableMeasure MeasureStartTimerManuallyBang #CURRENTCONFIG#
Command5=!UpdateMeasure MeasureStartTimerManuallyBang
StringAlign=Center

[MeasureTime]
Measure=Time

[MeasureTimerCounter] ; Integer representation of MeasureTime
Measure=Calc
Formula=MeasureTime
DynamicVariables=1

[MeasureStartTimerManuallyBang]
Measure=Calc
Formula=1
IfEqualValue=1
IfEqualAction=[!DisableMeasure MeasureStartTimerManuallyBang][!EnableMeasure MeasureStartTimerBang][!CommandMeasure "MeasureAhkWindowMessaging" "SendMessage 16687 0 #TimerDuration#"][!UpdateMeasure MeasureStartTimerBang][!EnableMeasure MeasureAlarmAction]
Disabled=1
DynamicVariables=1

[MeasureStartTimerAPIBang]
Measure=Calc
Formula=1
IfEqualValue=1
IfEqualAction=[!DisableMeasure MeasureStartTimerAPIBang][!EnableMeasure MeasureStartTimerBang][!UpdateMeasure MeasureStartTimerBang][!DisableMeasure MeasureAlarmAction]
Disabled=1
DynamicVariables=1

[MeasureStartTimerBang]
Measure=Calc
Formula=1
IfEqualValue=1
IfEqualAction=[!WriteKeyValue Variables TimerEndOfTimer (#TimerDuration#+[MeasureTimerCounter]) #@#state.inc][!WriteKeyValue Variables ColorTimerArc #ColorTimerArc# #@#state.inc][!WriteKeyValue Variables ActiveTimerCount #ActiveTimerCount# #@#state.inc][!DisableMeasure flashCounter][!SetVariable TimerEndOfTimer (#TimerDuration#+[MeasureTimerCounter])][!SetVariable EndOfTimerHash (frac((1+#EndOfTimerHash#*[MeasureTimerCounter])*0.5*(sqrt(5)-1)))][!DisableMeasure MeasureStartTimerBang][!WriteKeyValue Variables TimerEndOfTimer (#TimerDuration#+[MeasureTimerCounter]) #@#state.inc][!WriteKeyValue Variables ColorTimerArc #ColorTimerArc# #@#state.inc][!Update]
Disabled=1
DynamicVariables=1

[flashCounter]
Measure=Calc
Formula=(flashCounter<#FlashTimeoutSeconds#?flashCounter+1:0)
IfEqualValue=#FlashTimeoutSeconds#
IfEqualAction=[!DisableMeasure flashCounter]
DynamicVariables=1
Disabled=1

[MeasureTimeLeft]
Measure=Calc
Formula=(MeasureTimerCounter<=#TimerEndOfTimer#?#TimerEndOfTimer#-MeasureTimerCounter:-1)
DynamicVariables=1

[MeasureAlarmAction]
Measure=Calc
Formula=(MeasureTimerCounter<=#TimerEndOfTimer#?#TimerEndOfTimer#-MeasureTimerCounter:-1)
IfEqualValue=0
IfEqualAction=[Play Alarm.Wav]
IfEqualAction=" "
DynamicVariables=1
Disabled=1

[MeasureTimerBar]
Measure=Calc
Formula=(flashCounter?(MeasureTime%2):(MeasureTimeLeft)/#MaximumTimeDisplayed#)

[MeasureSecondsRemaining]
; includes leading zero
Measure=Calc
Formula=(MeasureTimeLeft%60/100)
Substitute="0.":""

[MeasureMinutesRemaining]
; includes leading zero
Measure=Calc
Formula=FLOOR(MeasureTimeLeft/60)/100
Substitute="0.":""

[MeasureAlways1]
Measure=Calc
Formula=1
UpdateDivider=-1

[MeasureAhkWindowMessaging]
Measure=Plugin
Plugin=WindowMessagePlugin
WindowClass=AutoHotkey

[MeasureTimerScript]
Measure=Script
ScriptFile=#@#timer.lua

;----------------------------------------------
; STYLES

[StyleText]
AntiAlias=1
StringAlign=CenterCenter
StringStyle=Bold
FontFace=#Font#
FontSize=#FontSize#
FontColor=#FontColor#

[StyleQuickButton]
Hidden=#StateButtonsHidden#
AntiAlias=1
StringAlign=CenterCenter
StringStyle=Bold
FontFace=#Font#
FontSize=#FontSize#
FontColor=#ThemeColorFull#
DynamicVariables=1
X=(#WidgetSize#+20)
Y=5R
W=30
H=30
UpdateDivider=-1
Group=ButtonGroup

[StyleArc]
X=0
Y=0
W=#WidgetSize#
H=#WidgetSize#
LineWidth=1
LineStart=0
StartAngle=4.7123889
RotationAngle=6.2831853
Solid=1
AntiAlias=1

;----------------------------------------------
; METERS

;-----------------------
; CLOCK background

[MeterBackgroundCircle]
Meter=ROUNDLINE
MeasureName=MeasureAlways1
MeterStyle=StyleArc
LineColor=#ColorBackground#
Solid=1
LineLength=(#ArcRadius#*#ArcTrackInnerRadiusRatio#)
LineStart=(#ArcRadius#*#ArcTrackOuterRadiusRatio#)
UpdateDivider=-1

[MeterTimer]
Meter=ROUNDLINE
MeasureName=MeasureTimerbar
MeterStyle=StyleArc
LineLength=(#ArcRadius#*#ArcTimerOuterRadiusRatio#)
LineStart=0
; was (#ArcRadius#*#ArcTimerOuterRadiusRatio#-#ArcTimerWidth#)
LineColor=#ColorTimerArc#
StartAngle=((-[MeasureTimerbar]/2-#EndOfTimerHash#)*2*PI)
DynamicVariables=1
;ValueRemainder=43200

; CENTER TEXT
[MeterCenterText]
Hidden=(#StateButtonsHidden#-1)
Meter=String
MeterStyle=StyleText
NumOfDecimals=2
MeasureName=MeasureTimerScript
X=(#WidgetSize#/2)
Y=(#WidgetSize#*5/8)
Text=%1
DynamicVariables=1
Group=ButtonGroup

[MeterBorderCircle]
Meter=ROUNDLINE
MeasureName=MeasureAlways1
MeterStyle=StyleArc
LineColor=#ColorBorder#
Solid=1
LineLength=(#ArcRadius#*#ArcBorderInnerRadiusRatio#)
LineStart=(#ArcRadius#*#ArcBorderOuterRadiusRatio#)
UpdateDivider=-1



;-----------------------
; Quick-set buttons

[MeterQuickButtonBack]
Hidden=#StateButtonsHidden#
DynamicVariables=1
UpdateDivider=-1
Group=ButtonGroup
Meter=Image
SolidColor=0,0,0,1
Y=0
X=0
H=#WidgetSize#
W=(#WidgetSize#+40)

[MeterQuickButton1]
Meter=STRING
MeterStyle=StyleQuickButton
SolidColor=#QuickTimer1Color#
Y=15
LeftMouseUpAction=[!SetVariable ActiveTimerCount 1][!SetVariable TimerDuration (#QuickTimer1PresetMinutes#*60)] [!SetVariable ColorTimerArc #QuickTimer1Color#] [!EnableMeasure MeasureStartTimerManuallyBang] [!UpdateMeasure MeasureStartTimerManuallyBang]
Text=#QuickTimer1PresetMinutes#

[MeterQuickButton2]
Meter=STRING
MeterStyle=StyleQuickButton
SolidColor=#QuickTimer2Color#
LeftMouseUpAction=[!SetVariable ActiveTimerCount 0][!SetVariable TimerDuration (#QuickTimer2PresetMinutes#*60)] [!SetVariable ColorTimerArc #QuickTimer2Color#] [!EnableMeasure MeasureStartTimerManuallyBang] [!UpdateMeasure MeasureStartTimerManuallyBang]
Text=#QuickTimer2PresetMinutes#

[MeterQuickButton3]
Meter=STRING
MeterStyle=StyleQuickButton
SolidColor=#DefaultTimerColor#
Text=?
LeftMouseUpAction=[!DisableMeasure flashCounter][!Update][!CommandMeasure "MeasureInput" "ExecuteBatch ALL"]

[MeterQuickButtonCount]
Meter=STRING
MeterStyle=StyleQuickButton
Y=(#WidgetSize#*5/16)
X=((#WidgetSize#)/2)
Text=#TimerCount#
LeftMouseDoubleClickAction=[!SetVariable TimerCount 0][!WriteKeyValue Variables TimerCount 0 #@#state.inc][!UpdateMeterGroup ButtonGroup][!Redraw]

;----------------------------------------------
; METADATA

[Metadata]
Name=MinimalTimer
Config=MinimalTimer
Description=An abstract, futuristic analog clock decorated with camouflaged system and song meters.
Instructions=See Legend.jpg to learn how to interpret Arcs.
Version=1.2
Tags=Time | System | Media
License=Creative Commons Attribution-Non-Commercial-Share Alike 3.0
Credits=Thanks to onewithnopaper for porting this from the original Samurize.
Preview=Preview.png
